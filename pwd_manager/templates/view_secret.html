{% extends "base.html" %}

{% block title %}View Secret - Password Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="text-center mb-4">Secret Details</h2>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{ entry.title }}</h5>
                {% if entry.has_login_info %}
                <div class="mb-3">
                    <label class="form-label">Website/Service</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ entry.website or '' }}" readonly>
                        {% if entry.website %}
                        <a href="{{ 'https://' + entry.website if not entry.website.startswith(('http://', 'https://')) else entry.website }}" 
                           class="btn btn-outline-secondary" target="_blank" rel="noopener noreferrer">Open</a>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ entry.username or '' }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this, '{{ entry.username or '' }}')">Copy</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="passwordField" data-password="{{ password }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this, '{{ password }}')">Copy</button>
                    </div>
                </div>
                {% endif %}
                {% if notes %}
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <div class="form-control markdown-content" style="min-height: 60px;">{{ notes|markdown }}</div>
                </div>
                {% endif %}
                {% if entry.has_login_info and qr_code %}
                <div class="mb-3">
                    <label class="form-label">QR Code</label>
                    <div>
                        <button class="btn btn-outline-secondary mb-3" type="button" id="toggleQR">Show QR Code</button>
                        <div id="qrCodeContainer" style="display: none;" class="text-center">
                            <img src="data:image/png;base64,{{ qr_code }}" alt="Password QR Code" class="img-fluid" style="max-width: 200px;">
                            <p class="text-muted mt-2"><small>Scan with your mobile device to copy the password</small></p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Attachments Section -->
                <div class="mb-3">
                    <label class="form-label">Attachments</label>
                    <div class="border rounded p-3">
                        <!-- Attachments List -->
                        <div id="attachmentsList">
                            <p class="text-muted mb-0" id="noAttachments">No attachments.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-3">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary me-2">Back to Secrets</a>
            <a href="{{ url_for('main.edit_secret', entry_id=entry.id) }}" class="btn btn-primary">Edit</a>
        </div>
    </div>
</div>

<!-- Attachment Preview Modal -->
<div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-labelledby="attachmentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attachmentPreviewModalLabel">Attachment Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Loading spinner -->
                <div id="previewLoading" class="py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading preview...</p>
                </div>
                
                <!-- Preview content -->
                <div id="previewContent" style="display: none;">
                    <!-- Image preview -->
                    <img id="previewImage" class="img-fluid" style="max-height: 60vh; display: none;" alt="Preview">
                    
                    <!-- PDF preview -->
                    <iframe id="previewPdf" style="width: 100%; height: 60vh; border: none; display: none;"></iframe>
                    
                    <!-- Text preview -->
                    <pre id="previewText" class="text-start p-3 border rounded" style="max-height: 60vh; overflow: auto; display: none;"></pre>
                    
                    <!-- Unsupported format message -->
                    <div id="previewUnsupported" style="display: none;" class="py-5">
                        <span style="font-size: 4rem;">ðŸ“Ž</span>
                        <p class="mt-3">Preview not available for this file type.</p>
                        <p class="text-muted">Click Download to view the file.</p>
                    </div>
                </div>
                
                <!-- File info -->
                <div id="previewFileInfo" class="mt-3 text-muted small" style="display: none;">
                    <span id="previewFilename"></span> &bull; <span id="previewFileSize"></span>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-secondary" id="prevAttachmentBtn" title="Previous">
                        <span>&larr;</span> Previous
                    </button>
                    <span id="attachmentCounter" class="mx-3"></span>
                    <button type="button" class="btn btn-outline-secondary" id="nextAttachmentBtn" title="Next">
                        Next <span>&rarr;</span>
                    </button>
                </div>
                <div>
                    <a href="#" class="btn btn-primary" id="previewDownloadBtn">Download</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('DOMContentLoaded', (event) => {
    const togglePasswordBtn = document.getElementById('togglePassword');
    if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', function() {
            const passwordInput = document.getElementById('passwordField');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            if (type === 'text') {
                passwordInput.value = passwordInput.getAttribute('data-password');
            } else {
                passwordInput.value = 'â€¢'.repeat(passwordInput.getAttribute('data-password').length);
            }
            this.textContent = type === 'password' ? 'Show' : 'Hide';
        });
    }

    const toggleQRBtn = document.getElementById('toggleQR');
    if (toggleQRBtn) {
        toggleQRBtn.addEventListener('click', function() {
            const qrContainer = document.getElementById('qrCodeContainer');
            const isHidden = window.getComputedStyle(qrContainer).display === 'none';
            qrContainer.style.display = isHidden ? 'block' : 'none';
            this.textContent = isHidden ? 'Hide QR Code' : 'Show QR Code';
        });
    }
});

function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(function() {
        button.textContent = 'Copied!';
        setTimeout(() => {
            button.textContent = 'Copy';
        }, 2000);
    });
}

// Attachment handling
const entryId = {{ entry.id }};
let attachmentsList = [];
let currentAttachmentIndex = 0;

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'ðŸ–¼ï¸';
    if (mimeType.includes('pdf')) return 'ðŸ“„';
    if (mimeType.includes('word') || mimeType.includes('document')) return 'ðŸ“';
    if (mimeType.includes('sheet') || mimeType.includes('excel') || mimeType.includes('csv')) return 'ðŸ“Š';
    return 'ðŸ“Ž';
}

function loadAttachments() {
    fetch(`/attachment/list/${entryId}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('attachmentsList');
            const noAttachments = document.getElementById('noAttachments');
            
            // Always clear existing items first
            const existingItems = container.querySelectorAll('.attachment-item');
            existingItems.forEach(item => item.remove());
            
            if (data.attachments && data.attachments.length > 0) {
                noAttachments.style.display = 'none';
                attachmentsList = data.attachments;
                
                data.attachments.forEach((att, index) => {
                    const item = document.createElement('div');
                    item.className = 'attachment-item d-flex justify-content-between align-items-center p-2 border-bottom';
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <div class="attachment-clickable flex-grow-1" data-index="${index}">
                            <span class="me-2">${getFileIcon(att.mime_type)}</span>
                            <span>${att.filename}</span>
                            <small class="text-muted ms-2">(${formatFileSize(att.size)})</small>
                        </div>
                        <div>
                            <a href="/attachment/download/${att.id}" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();">Download</a>
                        </div>
                    `;
                    // Click on the item to preview
                    item.querySelector('.attachment-clickable').addEventListener('click', () => openPreview(index));
                    container.appendChild(item);
                });
            } else {
                noAttachments.style.display = 'block';
                attachmentsList = [];
            }
        })
        .catch(error => {
            console.error('Error loading attachments:', error);
        });
}

// Preview modal functions
const previewModal = new bootstrap.Modal(document.getElementById('attachmentPreviewModal'));

function openPreview(index) {
    currentAttachmentIndex = index;
    showPreview();
    previewModal.show();
}

function showPreview() {
    const att = attachmentsList[currentAttachmentIndex];
    if (!att) return;
    
    // Update counter and navigation
    document.getElementById('attachmentCounter').textContent = `${currentAttachmentIndex + 1} / ${attachmentsList.length}`;
    document.getElementById('prevAttachmentBtn').disabled = currentAttachmentIndex === 0;
    document.getElementById('nextAttachmentBtn').disabled = currentAttachmentIndex === attachmentsList.length - 1;
    
    // Update download link
    document.getElementById('previewDownloadBtn').href = `/attachment/download/${att.id}`;
    
    // Update modal title
    document.getElementById('attachmentPreviewModalLabel').textContent = att.filename;
    
    // Update file info
    document.getElementById('previewFilename').textContent = att.filename;
    document.getElementById('previewFileSize').textContent = formatFileSize(att.size);
    
    // Hide all preview types first
    document.getElementById('previewImage').style.display = 'none';
    document.getElementById('previewPdf').style.display = 'none';
    document.getElementById('previewText').style.display = 'none';
    document.getElementById('previewUnsupported').style.display = 'none';
    
    const mimeType = att.mime_type;
    
    // For PDFs, load directly via iframe (backend serves file directly for PDFs)
    if (mimeType === 'application/pdf' || att.filename.toLowerCase().endsWith('.pdf')) {
        document.getElementById('previewLoading').style.display = 'none';
        document.getElementById('previewContent').style.display = 'block';
        document.getElementById('previewFileInfo').style.display = 'block';
        
        const iframe = document.getElementById('previewPdf');
        iframe.src = `/attachment/preview/${att.id}`;
        iframe.style.display = 'block';
        return;
    }
    
    // Show loading for other types
    document.getElementById('previewLoading').style.display = 'block';
    document.getElementById('previewContent').style.display = 'none';
    document.getElementById('previewFileInfo').style.display = 'none';
    
    // Fetch preview content for non-PDF files
    fetch(`/attachment/preview/${att.id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('previewLoading').style.display = 'none';
            document.getElementById('previewContent').style.display = 'block';
            document.getElementById('previewFileInfo').style.display = 'block';
            
            if (data.success) {
                const contentMimeType = data.mime_type;
                const content = data.content;
                
                if (contentMimeType.startsWith('image/')) {
                    // Image preview
                    const img = document.getElementById('previewImage');
                    img.src = `data:${contentMimeType};base64,${content}`;
                    img.style.display = 'block';
                } else if (contentMimeType.startsWith('text/') || contentMimeType === 'application/json' || contentMimeType === 'application/xml') {
                    // Text preview
                    const pre = document.getElementById('previewText');
                    try {
                        pre.textContent = atob(content);
                    } catch (e) {
                        pre.textContent = 'Unable to decode text content';
                    }
                    pre.style.display = 'block';
                } else {
                    // Unsupported format
                    document.getElementById('previewUnsupported').style.display = 'block';
                }
            } else {
                document.getElementById('previewUnsupported').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            document.getElementById('previewLoading').style.display = 'none';
            document.getElementById('previewContent').style.display = 'block';
            document.getElementById('previewUnsupported').style.display = 'block';
        });
}

function navigatePreview(direction) {
    const newIndex = currentAttachmentIndex + direction;
    if (newIndex >= 0 && newIndex < attachmentsList.length) {
        currentAttachmentIndex = newIndex;
        showPreview();
    }
}

// Navigation button handlers
document.getElementById('prevAttachmentBtn').addEventListener('click', () => navigatePreview(-1));
document.getElementById('nextAttachmentBtn').addEventListener('click', () => navigatePreview(1));

// Keyboard navigation
document.getElementById('attachmentPreviewModal').addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
        navigatePreview(-1);
    } else if (e.key === 'ArrowRight') {
        navigatePreview(1);
    }
});

// Initialize
loadAttachments();
</script>
{% endblock %}
