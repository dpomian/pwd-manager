{% extends "base.html" %}

{% block title %}Edit Secret - Password Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="text-center mb-4">Edit Secret</h2>
        <div class="card">
            <div class="card-body">
                <form method="POST" id="editForm">
                    <input type="hidden" name="has_login_info" id="hasLoginInfoHidden" value="{{ '1' if entry.has_login_info else '0' }}">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" value="{{ entry.title }}" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="hasLoginInfo" {{ 'checked' if entry.has_login_info else '' }}>
                            <label class="form-check-label" for="hasLoginInfo">Login Info</label>
                        </div>
                    </div>
                    <div id="loginInfoSection" style="display: {{ 'block' if entry.has_login_info else 'none' }};">
                        <div class="mb-3">
                            <label class="form-label">Website/Service</label>
                            <input type="text" class="form-control" id="website" name="website" value="{{ entry.website or '' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="username" name="username" value="{{ entry.username or '' }}">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this, '{{ entry.username or '' }}')">Copy</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="passwordField" name="password" value="{{ decrypted_password }}">
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this, '{{ decrypted_password }}')">Copy</button>
                                <button class="btn btn-outline-secondary" type="button" id="generatePassword">Generate</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" class="form-control" id="tags" name="tags" value="{{ entry.tags }}" placeholder="Example: work, email, social">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional notes (optional)">{{ decrypted_notes }}</textarea>
                    </div>
                </form>
                
                <!-- Attachments Section (outside form to avoid form submission issues) -->
                <div class="mb-3">
                    <label class="form-label">Attachments</label>
                    <div class="border rounded p-3">
                        <!-- Unified Drop Zone -->
                        <div id="dropZone" class="border rounded p-2 text-center mb-2" style="border-style: dashed !important; cursor: pointer; background-color: var(--card-bg); border-color: var(--border-color) !important; transition: all 0.2s ease;">
                            <input type="file" id="attachmentFile" style="display: none;" accept=".pdf,.doc,.docx,.txt,.rtf,.png,.jpg,.jpeg,.gif,.bmp,.webp,.xls,.xlsx,.csv,.json,.xml">
                            <div id="dropZoneDefault">
                                <p class="mb-0"><strong>Drop files here</strong>, <a href="#" id="browseLink">browse</a>, or paste an image</p>
                                <small class="text-muted">Max 10MB</small>
                            </div>
                            <div id="dropZoneDragOver" style="display: none;">
                                <p class="mb-0"><strong>Drop to upload</strong></p>
                            </div>
                        </div>
                        
                        <!-- File/Image Preview (before upload) -->
                        <div id="filePreview" class="mb-2" style="display: none;">
                            <div class="d-flex align-items-center gap-2 p-2 border rounded" style="background-color: var(--card-bg); border-color: var(--border-color) !important;">
                                <img id="previewThumbnail" style="max-height: 60px; max-width: 100px; display: none;" class="border rounded">
                                <span id="previewFileIcon" style="font-size: 2rem; display: none;"></span>
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control form-control-sm" id="previewFilename" placeholder="Filename">
                                    <small class="text-muted" id="previewFileSize"></small>
                                </div>
                                <button class="btn btn-sm btn-primary" type="button" id="confirmUploadBtn">Upload</button>
                                <button class="btn btn-sm btn-outline-secondary" type="button" id="cancelUploadBtn">Cancel</button>
                            </div>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="uploadProgress" class="progress mb-3" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                        
                        <!-- Attachments List -->
                        <div id="attachmentsList">
                            <p class="text-muted mb-0" id="noAttachments">No attachments yet.</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="{{ url_for('main.index') }}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" form="editForm" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attachment Preview Modal -->
<div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-labelledby="attachmentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attachmentPreviewModalLabel">Attachment Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Loading spinner -->
                <div id="previewLoading" class="py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading preview...</p>
                </div>
                
                <!-- Preview content -->
                <div id="previewContent" style="display: none;">
                    <!-- Image preview -->
                    <img id="previewImage" class="img-fluid" style="max-height: 60vh; display: none;" alt="Preview">
                    
                    <!-- PDF preview -->
                    <iframe id="previewPdf" style="width: 100%; height: 60vh; border: none; display: none;"></iframe>
                    
                    <!-- Text preview -->
                    <pre id="previewText" class="text-start p-3 border rounded" style="max-height: 60vh; overflow: auto; display: none;"></pre>
                    
                    <!-- Unsupported format message -->
                    <div id="previewUnsupported" style="display: none;" class="py-5">
                        <span style="font-size: 4rem;">ðŸ“Ž</span>
                        <p class="mt-3">Preview not available for this file type.</p>
                        <p class="text-muted">Click Download to view the file.</p>
                    </div>
                </div>
                
                <!-- File info -->
                <div id="previewFileInfo" class="mt-3 text-muted small" style="display: none;">
                    <span id="previewFilename"></span> &bull; <span id="previewFileSize"></span>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-secondary" id="prevAttachmentBtn" title="Previous">
                        <span>&larr;</span> Previous
                    </button>
                    <span id="attachmentCounter" class="mx-3"></span>
                    <button type="button" class="btn btn-outline-secondary" id="nextAttachmentBtn" title="Next">
                        Next <span>&rarr;</span>
                    </button>
                </div>
                <div>
                    <a href="#" class="btn btn-primary" id="previewDownloadBtn">Download</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('DOMContentLoaded', (event) => {
    // Toggle login info section
    const hasLoginInfoCheckbox = document.getElementById('hasLoginInfo');
    const hasLoginInfoHidden = document.getElementById('hasLoginInfoHidden');
    const loginInfoSection = document.getElementById('loginInfoSection');
    const websiteInput = document.getElementById('website');
    const usernameInput = document.getElementById('username');
    const passwordField = document.getElementById('passwordField');
    
    function toggleLoginInfoSection() {
        const isChecked = hasLoginInfoCheckbox.checked;
        loginInfoSection.style.display = isChecked ? 'block' : 'none';
        hasLoginInfoHidden.value = isChecked ? '1' : '0';
        
        // Set required attribute based on toggle state
        websiteInput.required = isChecked;
        usernameInput.required = isChecked;
        passwordField.required = isChecked;
    }
    
    hasLoginInfoCheckbox.addEventListener('change', toggleLoginInfoSection);
    
    // Initialize required state on page load
    toggleLoginInfoSection();

    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('passwordField');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.textContent = type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('generatePassword').addEventListener('click', function() {
        fetch("{{ url_for('main.generate_password_route') }}")
            .then(response => response.json())
            .then(data => {
                document.getElementById('passwordField').value = data.password;
            });
    });
});

function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(function() {
        button.textContent = 'Copied!';
        setTimeout(() => {
            button.textContent = 'Copy';
        }, 2000);
    });
}

// Attachment handling
const entryId = {{ entry.id }};
let attachmentsList = [];
let currentAttachmentIndex = 0;

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'ðŸ–¼ï¸';
    if (mimeType.includes('pdf')) return 'ðŸ“„';
    if (mimeType.includes('word') || mimeType.includes('document')) return 'ðŸ“';
    if (mimeType.includes('sheet') || mimeType.includes('excel') || mimeType.includes('csv')) return 'ðŸ“Š';
    return 'ðŸ“Ž';
}

function loadAttachments() {
    fetch(`/attachment/list/${entryId}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('attachmentsList');
            const noAttachments = document.getElementById('noAttachments');
            
            // Always clear existing items first
            const existingItems = container.querySelectorAll('.attachment-item');
            existingItems.forEach(item => item.remove());
            
            // Store attachments for preview navigation
            attachmentsList = data.attachments || [];
            
            if (attachmentsList.length > 0) {
                noAttachments.style.display = 'none';
                
                attachmentsList.forEach((att, index) => {
                    const item = document.createElement('div');
                    item.className = 'attachment-item d-flex justify-content-between align-items-center p-2 border-bottom';
                    item.innerHTML = `
                        <div>
                            <span class="me-2">${getFileIcon(att.mime_type)}</span>
                            <span class="attachment-clickable" onclick="openPreview(${index})" style="cursor: pointer;">${att.filename}</span>
                            <small class="text-muted ms-2">(${formatFileSize(att.size)})</small>
                        </div>
                        <div>
                            <a href="/attachment/download/${att.id}" class="btn btn-sm btn-outline-primary me-1">Download</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment('${att.id}')">Delete</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } else {
                noAttachments.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading attachments:', error);
        });
}

function deleteAttachment(attachmentId) {
    if (!confirm('Are you sure you want to delete this attachment?')) {
        return;
    }
    
    fetch(`/attachment/delete/${attachmentId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadAttachments();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error deleting attachment: ' + error);
    });
}

loadAttachments();

// Unified upload handling
const dropZone = document.getElementById('dropZone');
const dropZoneDefault = document.getElementById('dropZoneDefault');
const dropZoneDragOver = document.getElementById('dropZoneDragOver');
const fileInput = document.getElementById('attachmentFile');
const browseLink = document.getElementById('browseLink');
const filePreview = document.getElementById('filePreview');
const previewThumbnail = document.getElementById('previewThumbnail');
const previewFileIcon = document.getElementById('previewFileIcon');
const previewFilename = document.getElementById('previewFilename');
const previewFileSize = document.getElementById('previewFileSize');
const confirmUploadBtn = document.getElementById('confirmUploadBtn');
const cancelUploadBtn = document.getElementById('cancelUploadBtn');

let pendingFile = null;
let pendingClipboardData = null;

// Browse link click
browseLink.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    fileInput.click();
});

// Drop zone click (but not on the browse link)
dropZone.addEventListener('click', function(e) {
    if (e.target !== browseLink) {
        dropZone.focus();
    }
});

dropZone.setAttribute('tabindex', '0');

// File input change
fileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
        showFilePreview(this.files[0]);
    }
});

// Drag and drop
dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    dropZoneDefault.style.display = 'none';
    dropZoneDragOver.style.display = 'block';
    dropZone.style.backgroundColor = '#e3f2fd';
    dropZone.style.borderColor = '#2196f3';
});

dropZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    resetDropZoneStyle();
});

dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    resetDropZoneStyle();
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        showFilePreview(e.dataTransfer.files[0]);
    }
});

function resetDropZoneStyle() {
    dropZoneDefault.style.display = 'block';
    dropZoneDragOver.style.display = 'none';
    dropZone.style.backgroundColor = '';
    dropZone.style.borderColor = '';
}

// Clipboard paste
dropZone.addEventListener('paste', handlePaste);
document.addEventListener('paste', function(e) {
    const activeElement = document.activeElement;
    const isInputFocused = activeElement.tagName === 'INPUT' || 
                           activeElement.tagName === 'TEXTAREA' || 
                           activeElement.isContentEditable;
    
    if (!isInputFocused) {
        handlePaste(e);
    }
});

function handlePaste(e) {
    const items = e.clipboardData?.items;
    if (!items) return;
    
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            const blob = items[i].getAsFile();
            const reader = new FileReader();
            
            reader.onload = function(event) {
                pendingClipboardData = event.target.result;
                pendingFile = null;
                
                // Show preview
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `clipboard_${timestamp}.png`;
                
                previewThumbnail.src = pendingClipboardData;
                previewThumbnail.style.display = 'block';
                previewFileIcon.style.display = 'none';
                previewFilename.value = filename;
                previewFileSize.textContent = formatFileSize(blob.size);
                
                dropZone.style.display = 'none';
                filePreview.style.display = 'block';
            };
            
            reader.readAsDataURL(blob);
            break;
        }
    }
}

function showFilePreview(file) {
    pendingFile = file;
    pendingClipboardData = null;
    
    previewFilename.value = file.name;
    previewFileSize.textContent = formatFileSize(file.size);
    
    // Show thumbnail for images, icon for other files
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewThumbnail.src = e.target.result;
            previewThumbnail.style.display = 'block';
            previewFileIcon.style.display = 'none';
        };
        reader.readAsDataURL(file);
    } else {
        previewThumbnail.style.display = 'none';
        previewFileIcon.style.display = 'block';
        previewFileIcon.textContent = getFileIcon(file.type);
    }
    
    dropZone.style.display = 'none';
    filePreview.style.display = 'block';
}

// Confirm upload
confirmUploadBtn.addEventListener('click', function() {
    const progressBar = document.getElementById('uploadProgress');
    progressBar.style.display = 'block';
    
    if (pendingClipboardData) {
        // Upload clipboard image
        const filename = previewFilename.value.trim() || 'clipboard_image.png';
        
        fetch(`/attachment/upload-clipboard/${entryId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image_data: pendingClipboardData,
                filename: filename
            })
        })
        .then(response => response.json())
        .then(data => {
            progressBar.style.display = 'none';
            if (data.success) {
                resetPreview();
                loadAttachments();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            progressBar.style.display = 'none';
            alert('Error uploading: ' + error);
        });
    } else if (pendingFile) {
        // Upload regular file
        const formData = new FormData();
        
        // If filename was changed, create a new File with the new name
        const newFilename = previewFilename.value.trim();
        if (newFilename && newFilename !== pendingFile.name) {
            const renamedFile = new File([pendingFile], newFilename, { type: pendingFile.type });
            formData.append('file', renamedFile);
        } else {
            formData.append('file', pendingFile);
        }
        
        fetch(`/attachment/upload/${entryId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            progressBar.style.display = 'none';
            if (data.success) {
                resetPreview();
                loadAttachments();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            progressBar.style.display = 'none';
            alert('Error uploading: ' + error);
        });
    }
});

// Cancel upload
cancelUploadBtn.addEventListener('click', resetPreview);

function resetPreview() {
    pendingFile = null;
    pendingClipboardData = null;
    fileInput.value = '';
    previewThumbnail.src = '';
    previewThumbnail.style.display = 'none';
    previewFileIcon.style.display = 'none';
    previewFilename.value = '';
    previewFileSize.textContent = '';
    filePreview.style.display = 'none';
    dropZone.style.display = 'block';
}

// Preview modal functionality
const previewModal = new bootstrap.Modal(document.getElementById('attachmentPreviewModal'));

function openPreview(index) {
    currentAttachmentIndex = index;
    showPreview();
    previewModal.show();
}

function showPreview() {
    const att = attachmentsList[currentAttachmentIndex];
    if (!att) return;
    
    // Update counter and navigation
    document.getElementById('attachmentCounter').textContent = `${currentAttachmentIndex + 1} / ${attachmentsList.length}`;
    document.getElementById('prevAttachmentBtn').disabled = currentAttachmentIndex === 0;
    document.getElementById('nextAttachmentBtn').disabled = currentAttachmentIndex === attachmentsList.length - 1;
    
    // Update download link
    document.getElementById('previewDownloadBtn').href = `/attachment/download/${att.id}`;
    
    // Update modal title
    document.getElementById('attachmentPreviewModalLabel').textContent = att.filename;
    
    // Update file info
    document.getElementById('previewFilename').textContent = att.filename;
    document.getElementById('previewFileSize').textContent = formatFileSize(att.size);
    
    // Hide all preview types first
    document.getElementById('previewImage').style.display = 'none';
    document.getElementById('previewPdf').style.display = 'none';
    document.getElementById('previewText').style.display = 'none';
    document.getElementById('previewUnsupported').style.display = 'none';
    
    const mimeType = att.mime_type;
    
    // For PDFs, load directly via iframe (backend serves file directly for PDFs)
    if (mimeType === 'application/pdf' || att.filename.toLowerCase().endsWith('.pdf')) {
        document.getElementById('previewLoading').style.display = 'none';
        document.getElementById('previewContent').style.display = 'block';
        document.getElementById('previewFileInfo').style.display = 'block';
        
        const iframe = document.getElementById('previewPdf');
        iframe.src = `/attachment/preview/${att.id}`;
        iframe.style.display = 'block';
        return;
    }
    
    // Show loading for other types
    document.getElementById('previewLoading').style.display = 'block';
    document.getElementById('previewContent').style.display = 'none';
    document.getElementById('previewFileInfo').style.display = 'none';
    
    // Fetch preview content for non-PDF files
    fetch(`/attachment/preview/${att.id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('previewLoading').style.display = 'none';
            document.getElementById('previewContent').style.display = 'block';
            document.getElementById('previewFileInfo').style.display = 'block';
            
            if (data.success) {
                const contentMimeType = data.mime_type;
                const content = data.content;
                
                if (contentMimeType.startsWith('image/')) {
                    // Image preview
                    const img = document.getElementById('previewImage');
                    img.src = `data:${contentMimeType};base64,${content}`;
                    img.style.display = 'block';
                } else if (contentMimeType.startsWith('text/') || contentMimeType === 'application/json' || contentMimeType === 'application/xml') {
                    // Text preview
                    const pre = document.getElementById('previewText');
                    try {
                        pre.textContent = atob(content);
                    } catch (e) {
                        pre.textContent = 'Unable to decode text content';
                    }
                    pre.style.display = 'block';
                } else {
                    // Unsupported format
                    document.getElementById('previewUnsupported').style.display = 'block';
                }
            } else {
                document.getElementById('previewUnsupported').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading preview:', error);
            document.getElementById('previewLoading').style.display = 'none';
            document.getElementById('previewContent').style.display = 'block';
            document.getElementById('previewUnsupported').style.display = 'block';
        });
}

function navigatePreview(direction) {
    const newIndex = currentAttachmentIndex + direction;
    if (newIndex >= 0 && newIndex < attachmentsList.length) {
        currentAttachmentIndex = newIndex;
        showPreview();
    }
}

// Navigation button handlers
document.getElementById('prevAttachmentBtn').addEventListener('click', () => navigatePreview(-1));
document.getElementById('nextAttachmentBtn').addEventListener('click', () => navigatePreview(1));

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('attachmentPreviewModal');
    if (modal.classList.contains('show')) {
        if (e.key === 'ArrowLeft') navigatePreview(-1);
        if (e.key === 'ArrowRight') navigatePreview(1);
    }
});
</script>
{% endblock %}
