{% extends "base.html" %}

{% block title %}Edit Secret - Password Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="text-center mb-4">Edit Secret</h2>
        <div class="card">
            <div class="card-body">
                <form method="POST" id="editForm">
                    <h5 class="card-title mb-4">{{ entry.website }}</h5>
                    <div class="mb-3">
                        <label class="form-label">Website/Service</label>
                        <input type="text" class="form-control" id="website" name="website" value="{{ entry.website }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="username" name="username" value="{{ entry.username }}" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this, '{{ entry.username }}')">Copy</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="passwordField" name="password" value="{{ decrypted_password }}" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this, '{{ decrypted_password }}')">Copy</button>
                            <button class="btn btn-outline-secondary" type="button" id="generatePassword">Generate</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <input type="text" class="form-control" id="tags" name="tags" value="{{ entry.tags }}" placeholder="Example: work, email, social">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional notes (optional)">{{ decrypted_notes }}</textarea>
                    </div>
                </form>
                
                <!-- Attachments Section (outside form to avoid form submission issues) -->
                <div class="mb-3">
                    <label class="form-label">Attachments</label>
                    <div class="border rounded p-3">
                        <!-- Upload Form -->
                        <div class="mb-3">
                            <div class="input-group">
                                <input type="file" class="form-control" id="attachmentFile" accept=".pdf,.doc,.docx,.txt,.rtf,.png,.jpg,.jpeg,.gif,.bmp,.webp,.xls,.xlsx,.csv,.json,.xml">
                                <button class="btn btn-outline-primary" type="button" id="uploadBtn">Upload</button>
                            </div>
                            <small class="text-muted">Max 10MB. Allowed: PDF, DOC, DOCX, TXT, RTF, PNG, JPG, GIF, XLS, XLSX, CSV, JSON, XML</small>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="uploadProgress" class="progress mb-3" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                        
                        <!-- Attachments List -->
                        <div id="attachmentsList">
                            <p class="text-muted mb-0" id="noAttachments">No attachments yet.</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="{{ url_for('main.index') }}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" form="editForm" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('DOMContentLoaded', (event) => {
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('passwordField');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.textContent = type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('generatePassword').addEventListener('click', function() {
        fetch("{{ url_for('main.generate_password_route') }}")
            .then(response => response.json())
            .then(data => {
                document.getElementById('passwordField').value = data.password;
            });
    });
});

function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(function() {
        button.textContent = 'Copied!';
        setTimeout(() => {
            button.textContent = 'Copy';
        }, 2000);
    });
}

// Attachment handling
const entryId = {{ entry.id }};

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'ðŸ–¼ï¸';
    if (mimeType.includes('pdf')) return 'ðŸ“„';
    if (mimeType.includes('word') || mimeType.includes('document')) return 'ðŸ“';
    if (mimeType.includes('sheet') || mimeType.includes('excel') || mimeType.includes('csv')) return 'ðŸ“Š';
    return 'ðŸ“Ž';
}

function loadAttachments() {
    fetch(`/attachment/list/${entryId}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('attachmentsList');
            const noAttachments = document.getElementById('noAttachments');
            
            // Always clear existing items first
            const existingItems = container.querySelectorAll('.attachment-item');
            existingItems.forEach(item => item.remove());
            
            if (data.attachments && data.attachments.length > 0) {
                noAttachments.style.display = 'none';
                
                data.attachments.forEach(att => {
                    const item = document.createElement('div');
                    item.className = 'attachment-item d-flex justify-content-between align-items-center p-2 border-bottom';
                    item.innerHTML = `
                        <div>
                            <span class="me-2">${getFileIcon(att.mime_type)}</span>
                            <span>${att.filename}</span>
                            <small class="text-muted ms-2">(${formatFileSize(att.size)})</small>
                        </div>
                        <div>
                            <a href="/attachment/download/${att.id}" class="btn btn-sm btn-outline-primary me-1">Download</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAttachment('${att.id}')">Delete</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } else {
                noAttachments.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading attachments:', error);
        });
}

function uploadAttachment() {
    const fileInput = document.getElementById('attachmentFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to upload.');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    const progressBar = document.getElementById('uploadProgress');
    progressBar.style.display = 'block';
    
    fetch(`/attachment/upload/${entryId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.display = 'none';
        fileInput.value = '';
        
        if (data.success) {
            loadAttachments();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        progressBar.style.display = 'none';
        alert('Error uploading file: ' + error);
    });
}

function deleteAttachment(attachmentId) {
    if (!confirm('Are you sure you want to delete this attachment?')) {
        return;
    }
    
    fetch(`/attachment/delete/${attachmentId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadAttachments();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error deleting attachment: ' + error);
    });
}

document.getElementById('uploadBtn').addEventListener('click', uploadAttachment);
loadAttachments();
</script>
{% endblock %}
